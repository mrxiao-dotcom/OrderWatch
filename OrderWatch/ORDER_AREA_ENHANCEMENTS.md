# 下单区域功能增强说明

## 🎯 功能概述

已成功实现下单区域的全面功能增强，包括：
1. 杠杆默认值优化
2. 止损比例快捷按钮
3. 以损定量自动计算和快捷调整
4. 数量自动计算和标准化
5. 新增"保盈加仓"功能

## ✨ 主要功能

### 1. 杠杆设置优化
- **默认值**：杠杆默认设置为10倍
- **选项扩展**：新增50倍和100倍选项
- **支持范围**：1x, 5x, 10x, 20x, 50x, 100x

### 2. 止损比例快捷按钮
- **快捷按钮**：5%、10%、20%
- **一键设置**：点击按钮直接设置止损比例
- **自动计算**：设置后自动计算数量

### 3. 以损定量功能
- **自动计算**：双击合约后自动计算基础风险金额
- **计算公式**：基础风险金额 = 账户权益 ÷ 风险笔数（取整）
- **快捷调整**：
  - **加倍**：增加一份基础风险金额
  - **加半**：增加半份基础风险金额
  - **减半**：减少到原来的一半

### 4. 数量自动计算
- **计算公式**：数量 = (以损定量 ÷ 止损比例) ÷ 最新价格
- **实时更新**：止损比例或以损定量变化时自动重新计算
- **数量标准化**：根据币安精度要求调整数量

### 5. 保盈加仓功能
- **新增按钮**：在市价下单按钮旁添加"保盈加仓"按钮
- **功能说明**：专门用于盈利后的加仓操作
- **样式设计**：紫色背景，与市价下单按钮并排显示

## 🔧 技术实现

### 新增属性
```csharp
[ObservableProperty]
private int _riskTrades = 1; // 风险笔数，默认为1
```

### 新增命令
```csharp
// 止损比例设置命令
[RelayCommand]
private void SetStopLossRatio(object parameter)

// 以损定量调整命令
[RelayCommand]
private void AdjustRiskAmount(object parameter)

// 保盈加仓命令
[RelayCommand]
private async Task PlaceProfitOrderAsync()
```

### 新增辅助方法
```csharp
/// <summary>
/// 获取基础风险金额（账户权益除以风险笔数）
/// </summary>
private decimal GetBaseRiskAmount()

/// <summary>
/// 根据以损定量自动计算数量
/// </summary>
private async Task CalculateQuantityFromRiskAmountAsync()

/// <summary>
/// 标准化数量（根据币安要求调整精度）
/// </summary>
private async Task<decimal> StandardizeQuantityAsync(string symbol, decimal quantity)
```

### 属性变化处理器
```csharp
partial void OnConditionalStopLossRatioChanged(decimal value)
partial void OnRiskAmountChanged(decimal value)
```

## 🎨 界面布局

### 止损比例区域
- **标签**：止损比例
- **输入框**：可编辑的百分比输入
- **快捷按钮**：5%、10%、20%（蓝色背景）

### 以损定量区域
- **标签**：以损定量
- **输入框**：可编辑的USDT金额输入
- **快捷按钮**：加倍（橙色）、加半（绿色）、减半（红色）

### 数量设置区域
- **标签**：数量
- **输入框**：只读，显示"(自动)"提示
- **背景色**：浅灰色，表示自动计算

### 市价下单区域
- **市价下单按钮**：绿色背景，宽度100px
- **保盈加仓按钮**：紫色背景，宽度100px，间距5px

## 📋 使用说明

### 1. 设置止损比例
1. 点击快捷按钮（5%、10%、20%）直接设置
2. 或手动输入百分比数值
3. 系统自动计算数量

### 2. 调整以损定量
1. **双击合约**：自动计算基础风险金额
2. **快捷调整**：
   - 点击"加倍"：增加一份基础风险金额
   - 点击"加半"：增加半份基础风险金额
   - 点击"减半"：减少到原来的一半
3. **手动编辑**：直接在输入框中输入金额

### 3. 数量自动计算
- 数量根据以损定量和止损比例自动计算
- 计算公式：数量 = (以损定量 ÷ 止损比例) ÷ 最新价格
- 数量自动标准化处理（精度调整）

### 4. 保盈加仓操作
1. 设置好下单参数（合约、方向、数量等）
2. 点击"💰 保盈加仓"按钮
3. 系统执行加仓操作

## 🚀 优势特点

1. **操作便捷**：一键设置止损比例，快捷调整以损定量
2. **智能计算**：自动计算基础风险金额和数量
3. **实时更新**：参数变化时自动重新计算
4. **标准化处理**：数量自动调整到币安要求的精度
5. **功能完整**：覆盖所有下单场景，包括保盈加仓

## 🔄 下一步

1. **关闭当前运行的程序**
2. **重新编译项目**：`dotnet build`
3. **运行程序**：测试新的下单功能

## ✅ 实现状态

- [x] 杠杆默认值优化
- [x] 止损比例快捷按钮
- [x] 以损定量自动计算
- [x] 以损定量快捷调整
- [x] 数量自动计算
- [x] 数量标准化处理
- [x] 保盈加仓功能
- [x] 属性变化处理器
- [x] 错误处理和日志记录

下单区域功能增强现已完全实现，用户可以享受更智能、更便捷的下单体验！
