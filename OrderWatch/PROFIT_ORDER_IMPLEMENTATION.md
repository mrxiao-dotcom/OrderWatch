# 保盈加仓功能实现

## 功能概述
保盈加仓功能允许用户在持仓有足够浮盈时进行加仓操作，系统会自动设置止损单以保护利润。

## 功能特点

### 1. 基本逻辑
- 按照设定的数量下市价单
- 下单方向与持仓单方向一致
- 自动检查浮盈是否满足要求

### 2. 浮盈限制
- 必须浮盈大于至少50%的风险金
- 计算公式：`minProfitRequired = RiskAmount * 0.5`
- 如果浮盈不足，会显示具体需要和当前的浮盈金额

### 3. 自动止损设置
- 下单成功后，以下入场价为触发价设置止损委托
- 止损单类型：`STOP_MARKET`（市价止损）
- 止损方向：与持仓方向相反
- 止损单属性：`ReduceOnly = true`（必须是减仓单）

### 4. 止损委托管理
- 自动取消之前的止损委托
- 支持多种止损单类型：`STOP_MARKET`、`STOP_LIMIT`、`STOP`、`STOP_LOSS`
- 批量取消，确保没有遗漏

## 技术实现

### 1. 主要方法
- `PlaceProfitOrderAsync()`: 保盈加仓主方法
- `CancelExistingStopLossOrdersAsync()`: 取消现有止损委托

### 2. 执行流程
```
1. 参数验证
   ├── 检查账户信息
   ├── 检查合约和数量
   └── 查找对应持仓

2. 浮盈检查
   ├── 计算最小浮盈要求（50%风险金）
   └── 验证当前浮盈是否满足

3. 确定下单方向
   ├── 多头持仓 → 买入
   └── 空头持仓 → 卖出

4. 用户确认
   ├── 显示详细确认信息
   └── 等待用户确认

5. 执行保盈加仓
   ├── 下市价单
   └── 检查下单结果

6. 设置止损单
   ├── 取消现有止损委托
   ├── 设置新的止损委托
   └── 触发价 = 入场价

7. 完成操作
   ├── 更新状态信息
   ├── 记录日志
   └── 刷新数据
```

### 3. 关键参数

#### 保盈加仓订单
- **类型**: `MARKET`（市价单）
- **时间有效性**: `IOC`（立即成交或取消）
- **减仓**: `false`（加仓）
- **持仓方向**: 与现有持仓一致

#### 止损委托
- **类型**: `STOP_MARKET`（市价止损）
- **触发价**: 持仓入场价
- **时间有效性**: `GTC`（成交前有效）
- **减仓**: `true`（必须是减仓单）
- **持仓方向**: 与持仓一致

### 4. 错误处理
- 持仓不存在：显示错误信息
- 浮盈不足：显示具体数值要求
- 下单失败：记录错误日志
- 止损单设置失败：记录警告日志
- 异常情况：完整的异常捕获和日志记录

## 用户界面

### 1. 确认对话框
显示以下信息：
- 合约名称
- 下单方向（买入/卖出）和持仓方向（LONG/SHORT）
- 数量
- 当前浮盈
- 入场价
- 最新价

### 2. 状态提示
- 执行过程中：显示当前步骤
- 成功完成：显示成功信息和止损单设置状态
- 失败情况：显示具体错误原因

## 安全特性

### 1. 浮盈验证
- 严格的浮盈检查，防止在亏损状态下加仓
- 可配置的浮盈比例（当前固定为50%）

### 2. 止损保护
- 自动设置止损单，保护加仓部分的利润
- 以入场价为触发价，确保不亏损

### 3. 委托管理
- 自动清理旧的止损委托，避免重复设置
- 支持多种止损单类型的识别和取消

## 使用场景

### 1. 趋势跟踪
- 在强势趋势中，利用浮盈进行加仓
- 通过止损单保护已有利润

### 2. 风险控制
- 只在有足够浮盈时加仓
- 自动设置止损，控制风险

### 3. 利润最大化
- 在有利时机增加仓位
- 通过止损单锁定利润

## 注意事项

### 1. 前置条件
- 必须有对应合约的持仓
- 浮盈必须大于50%的风险金
- 需要有效的API凭据

### 2. 风险提示
- 加仓会增加总体风险敞口
- 止损单可能因市场波动而触发
- 建议在明确的趋势中使用

### 3. 技术限制
- 依赖币安API的稳定性
- 网络延迟可能影响委托执行
- 需要确保账户有足够的保证金

## 日志记录

### 1. 操作日志
- 保盈加仓成功/失败
- 止损单设置成功/失败
- 委托取消操作

### 2. 错误日志
- 参数验证失败
- API调用异常
- 网络连接问题

### 3. 交易日志
- 加仓订单详情
- 止损单设置详情
- 委托取消详情
