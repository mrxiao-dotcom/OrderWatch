# 风险管理和价格偏差功能说明

## 🎯 功能概述

已成功实现以下功能改进：
1. **风险次数管理**：将"风险倍数"改为"风险次数"，更准确地反映风险管理概念
2. **风险金自动计算**：风险金 = 账户权益 ÷ 风险次数，自动填入以损定量
3. **价格偏差百分比显示**：在所有价格输入框旁显示与最新价的偏差百分比

## ✨ 主要功能

### 1. 风险次数管理
- **标签更新**：账户配置窗口中的"风险倍数"改为"风险次数"
- **概念优化**：更准确地反映将账户资金分成几份进行风险管理的概念
- **属性保持**：继续使用`RiskCapitalTimes`属性，确保向后兼容

### 2. 风险金自动计算
- **计算公式**：基础风险金额 = 账户权益 ÷ 风险次数（取整）
- **自动填入**：双击合约后自动计算并填入以损定量输入框
- **实时更新**：当账户权益或风险次数变化时自动重新计算

### 3. 价格偏差百分比显示
- **显示位置**：在所有价格输入框右侧显示偏差百分比
- **计算方式**：偏差 = (当前价格 - 最新价格) ÷ 最新价格 × 100%
- **格式规范**：保留2位小数，正数显示"+"号，负数显示"-"号
- **实时更新**：价格变化时自动重新计算偏差百分比

## 🔧 技术实现

### 新增属性
```csharp
// 价格偏差百分比属性
[ObservableProperty]
private string _limitPriceDeviation = string.Empty;

[ObservableProperty]
private string _longBreakoutPriceDeviation = string.Empty;

[ObservableProperty]
private string _shortBreakdownPriceDeviation = string.Empty;
```

### 新增方法
```csharp
/// <summary>
/// 计算价格偏差百分比
/// </summary>
private string CalculatePriceDeviation(decimal currentPrice, decimal latestPrice)
{
    if (latestPrice <= 0 || currentPrice <= 0)
        return string.Empty;

    var deviation = ((currentPrice - latestPrice) / latestPrice) * 100;
    var sign = deviation >= 0 ? "+" : "";
    return $"{sign}{deviation:F2}%";
}
```

### 属性变化处理器
```csharp
partial void OnLimitPriceChanged(decimal value)
partial void OnLongBreakoutPriceChanged(decimal value)
partial void OnShortBreakdownPriceChanged(decimal value)
```

## 🎨 界面布局

### 账户配置窗口
- **风险次数标签**：显示"风险次数:"而不是"风险倍数:"
- **输入框**：保持原有的`RiskCapitalTimes`属性绑定

### 价格输入区域
- **限价单价格**：价格输入框右侧显示偏差百分比
- **做多突破价格**：价格输入框右侧显示偏差百分比
- **做空跌破价格**：价格输入框右侧显示偏差百分比

### 偏差百分比样式
- **字体大小**：9号字体，确保不占用过多空间
- **颜色**：灰色（#666），与主界面协调
- **边距**：左侧5px间距，最小宽度50px

## 📋 使用说明

### 1. 设置风险次数
1. 在账户配置窗口中设置"风险次数"
2. 系统自动计算：基础风险金额 = 账户权益 ÷ 风险次数
3. 双击合约后，以损定量自动填入基础风险金额

### 2. 查看价格偏差
1. **限价单**：在价格输入框右侧显示偏差百分比
2. **做多条件**：在突破价格输入框右侧显示偏差百分比
3. **做空条件**：在跌破价格输入框右侧显示偏差百分比

### 3. 偏差百分比含义
- **+2.45%**：当前价格比最新价格高2.45%
- **-1.23%**：当前价格比最新价格低1.23%
- **空值**：当价格或最新价格为0时不显示

## 🚀 优势特点

1. **概念清晰**：风险次数比风险倍数更直观易懂
2. **自动计算**：风险金自动计算，减少手动输入错误
3. **实时反馈**：价格偏差百分比实时显示，帮助用户了解价格位置
4. **格式规范**：偏差百分比格式统一，保留2位小数
5. **界面协调**：偏差显示不占用过多空间，与主界面风格一致

## 🔄 下一步

1. **关闭当前运行的程序**
2. **重新编译项目**：`dotnet build`
3. **运行程序**：测试新的风险管理和价格偏差功能

## ✅ 实现状态

- [x] 风险次数标签更新
- [x] 风险金自动计算逻辑
- [x] 价格偏差百分比属性
- [x] 价格偏差计算方法
- [x] 属性变化处理器
- [x] 界面布局更新
- [x] 自动计算和显示逻辑

所有功能已成功实现，用户可以享受更智能的风险管理和更直观的价格偏差显示！
