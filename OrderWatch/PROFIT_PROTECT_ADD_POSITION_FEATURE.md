# 保盈加仓功能实现说明

## 🎯 功能概述

保盈加仓是一种风险控制策略，只有在持仓浮盈达到一定标准（50%风险金）时才允许加仓，确保即使加仓后价格回调也不会亏损。

## ✅ 功能特性

### 1. 严格的前置条件检查
- **停止刷新检查**：必须手动停止自动刷新，确保操作者专注
- **持仓选择检查**：必须选中一个具体的持仓进行加仓
- **浮盈要求检查**：当前浮盈必须≥50%风险金额

### 2. 详细的确认对话框
- **当前持仓信息**：合约、方向、数量、进场价、浮盈状态
- **加仓计划详情**：方向、数量、杠杆、当前价格、市值
- **操作说明**：明确告知将执行的两步操作

### 3. 完整的操作流程
1. **市价开仓加仓**：按照当前持仓同方向进行加仓
2. **自动设置ReduceOnly止损**：为加仓部分设置保护性止损单
3. **交易历史记录**：完整记录操作过程
4. **数据刷新**：操作完成后自动刷新持仓数据

## 🔧 技术实现

### 核心命令方法
```csharp
[RelayCommand]
private async Task ProfitProtectAddPositionAsync()
```

### 关键安全检查
```csharp
// 1. 停止刷新检查
if (AutoRefreshEnabled)
{
    await ShowErrorDialogAsync("保盈加仓操作前需要停止自动刷新...");
    return;
}

// 2. 50%风险金检查
var baseRiskAmount = GetBaseRiskAmount();
var requiredProfit = baseRiskAmount * 0.5m; // 50%风险金
if (SelectedPosition.UnRealizedProfit < requiredProfit)
{
    // 显示不满足条件的详细信息
    return;
}
```

### ReduceOnly止损单设置
```csharp
var stopLossRequest = new TradingRequest
{
    Symbol = position.Symbol,
    Side = stopLossSide,
    Type = "STOP_MARKET",
    Quantity = addQuantity,
    StopPrice = stopLossPrice,
    ReduceOnly = true, // 关键：只减仓，不增仓
    WorkingType = "CONTRACT_PRICE"
};
```

## 📋 使用流程

### 第一步：准备条件
1. 确保有持仓且浮盈充足（≥50%风险金）
2. 点击"停止刷新"按钮
3. 在持仓列表中选中要加仓的持仓

### 第二步：执行保盈加仓
1. 点击"💰 保盈加仓"按钮
2. 系统自动检查条件
3. 如果条件满足，显示确认对话框
4. 仔细查看加仓计划，确认无误后点击"是"

### 第三步：监控结果
1. 系统执行市价开仓
2. 自动设置ReduceOnly止损保护
3. 查看操作结果和日志记录

## ⚠️ 重要说明

### 风险控制要点
1. **50%风险金要求**：这是硬性条件，确保有足够安全边际
2. **ReduceOnly止损**：加仓部分的止损单设置为只减仓，避免意外增仓
3. **同等数量加仓**：加仓数量等于当前持仓数量，保持策略一致性

### 操作注意事项
1. **停止刷新必要性**：避免在操作过程中数据变化导致判断错误
2. **选择正确持仓**：确保选中的是要加仓的持仓，而非其他合约
3. **确认对话框**：仔细核对所有参数，特别是方向和数量

### 风险提示
1. 保盈加仓仍有风险，市场可能急速逆转
2. 止损单可能因为市场流动性问题执行不理想
3. 建议在趋势明确且流动性充足时使用

## 🛠️ 故障排除

### 常见问题及解决方案

**问题1：提示"需要停止刷新"**
- 解决：点击界面上的"停止刷新"按钮

**问题2：提示"浮盈不足"**
- 解决：等待浮盈达到要求，或调整风险金设置

**问题3：开仓成功但止损设置失败**
- 说明：系统会记录警告，开仓已成功，可手动设置止损

**问题4：无法获取最新价格**
- 解决：检查网络连接，稍后重试

## 📊 相关设置

### 风险金计算
- 基础风险金 = 账户权益 ÷ 风险次数
- 要求浮盈 = 基础风险金 × 50%

### 止损比例设置
- 默认止损比例：2%
- 可在代码中调整 `stopLossRatio` 参数

## 🎉 功能亮点

1. **智能风控**：只有盈利充足时才允许加仓
2. **自动保护**：加仓后立即设置止损保护
3. **操作便捷**：一键完成复杂的加仓+止损操作
4. **记录完整**：所有操作都有详细的日志和历史记录
5. **界面友好**：清晰的状态提示和确认对话框

这个功能将帮助用户更安全地进行加仓操作，在保护已有盈利的前提下扩大收益潜力。 